<!--pages/match-detail/match-detail.wxml - æ¯”èµ›è¯¦æƒ…-->
<view class="container" wx:if="{{match}}">
  <view class="card match-info">
    <view class="match-name">{{match.name}}</view>
    <view class="match-meta">
      <text class="status-tag status-{{match.status}}">{{match.status === 'registering' ? 'æŠ¥åä¸­' : match.status === 'teaming' ? 'ç»„é˜Ÿä¸­' : match.status === 'playing' ? 'è¿›è¡Œä¸­' : 'å·²ç»“æŸ'}}</text>
      <text class="mode-tag">{{match.type === 'singles' ? 'å•æ‰“' : 'åŒæ‰“'}} - {{match.subMode === 'single-turn' ? 'å•æ‰“è½¬' : match.subMode === 'team-turn' ? 'å°é˜Ÿè½¬' : 'æ™‹çº§èµ›'}}</text>
    </view>
    <view class="match-stats">
      <text>æŠ¥åäººæ•°ï¼š{{match.players ? match.players.length : 0}} / {{match.maxPlayers}}</text>
    </view>
    <view class="match-extras" wx:if="{{match.location || match.time || match.startTime || match.endTime || match.courtNumber}}">
      <text wx:if="{{match.startTime && match.endTime}}">æ—¶é—´ï¼š{{match.startTime}} - {{match.endTime}}</text>
      <text wx:elif="{{match.startTime}}">å¼€å§‹ï¼š{{match.startTime}}</text>
      <text wx:elif="{{match.time}}">æ—¶é—´ï¼š{{match.time}}</text>
      <text wx:if="{{match.location}}">åœ°ç‚¹ï¼š{{match.location}}</text>
      <text wx:if="{{match.location && match.courtNumber}}"> ({{match.courtNumber}})</text>
    </view>
  </view>

  <!-- Tab å¯¼èˆª -->
  <view class="tabs">
    <view class="tab-item {{activeTab === 0 ? 'active' : ''}}" data-index="0" bindtap="onTabChange">æ¯”èµ›</view>
    <view class="tab-item {{activeTab === 1 ? 'active' : ''}}" data-index="1" bindtap="onTabChange">æ’å</view>
    <view class="tab-item {{activeTab === 2 ? 'active' : ''}}" data-index="2" bindtap="onTabChange">å¯¹å±€</view>
  </view>

  <!-- ç¬¬ä¸€æ ï¼šæ¯”èµ›ï¼ˆæŠ¥åï¼‰ -->
  <view class="tab-content" wx:if="{{activeTab === 0}}">
    <view class="card">
      <view class="section-title">æŠ¥ååˆ—è¡¨</view>

      <block wx:if="{{match.subMode === 'team-turn' && teamList.length > 0}}">
        <view class="team-cards">
          <view
            class="team-card {{myTeamIndex === item.teamIndex ? 'my-team' : ''}}"
            wx:for="{{teamList}}"
            wx:key="teamIndex"
          >
            <view class="team-card-header">
              <text class="team-label">{{item.teamLabel}}</text>
              <text class="team-count">({{item.players ? item.players.length : 0}}äºº)</text>
              <text class="my-team-tag" wx:if="{{myTeamIndex === item.teamIndex}}">æˆ‘çš„é˜Ÿä¼</text>
            </view>
            <view class="team-players" wx:if="{{item.players && item.players.length > 0}}">
              <view class="player-item" wx:for="{{item.players}}" wx:for-item="p" wx:key="_id">
                <image class="avatar" src="{{p.avatarUrl}}" mode="aspectFill" wx:if="{{p.avatarUrl}}"></image>
                <view class="avatar avatar-placeholder" wx:else></view>
                <text>{{p.nickName || 'æœªçŸ¥'}}</text>
              </view>
            </view>
            <view class="empty-tip" wx:else>æš‚æ— æˆå‘˜</view>
            <button
              wx:if="{{hasJoined && myTeamIndex === item.teamIndex && match.status === 'registering' && teamList.length > 1}}"
              class="btn-switch-team"
              bindtap="onSwitchTeamTap"
            >åˆ‡æ¢é˜Ÿä¼</button>
          </view>
        </view>
      </block>

      <block wx:else>
        <view class="player-list" wx:if="{{playerList.length > 0}}">
          <view class="player-item" wx:for="{{playerList}}" wx:key="_id">
            <image class="avatar" src="{{item.avatarUrl}}" mode="aspectFill" wx:if="{{item.avatarUrl}}"></image>
            <view class="avatar avatar-placeholder" wx:else></view>
            <text>{{item.nickName || 'æœªçŸ¥'}}</text>
          </view>
        </view>
        <view class="empty-tip" wx:else>æš‚æ— æŠ¥å</view>
      </block>
    </view>

    <view class="actions">
      <button
        wx:if="{{!hasJoined && match.status === 'registering'}}"
        class="btn-primary"
        bindtap="onJoinTap"
      >ç«‹å³æŠ¥å</button>

      <button
        wx:if="{{isCreator && match.status === 'registering'}}"
        class="btn-robot"
        bindtap="onAddRobotTap"
      >æ·»åŠ æœºå™¨äººï¼ˆæµ‹è¯•ï¼‰</button>

      <button
        wx:if="{{isCreator && match.status === 'registering' && match.players && match.players.length >= match.minPlayers}}"
        class="btn-primary"
        bindtap="onStartTeamTap"
      >å¼€å§‹ç»„é˜Ÿ</button>
    </view>
  </view>

  <!-- ç¬¬äºŒæ ï¼šæ’å -->
  <view class="tab-content" wx:if="{{activeTab === 1 && match.teams && (match.status === 'teaming' || match.status === 'playing' || match.status === 'finished')}}">
    <block wx:if="{{match.subMode === 'team-turn' && teamRankings && teamRankings.length > 0}}">
      <view class="card ranking-card">
        <view class="section-title">é˜Ÿä¼æ’å</view>
        <view class="team-rank-table">
          <view class="team-rank-header">
            <text class="team-col-rank">æ’å</text>
            <text class="team-col-name">é˜Ÿä¼</text>
            <text class="team-col-wl">èƒœ-è´Ÿ</text>
            <text class="team-col-pts">ç§¯åˆ†</text>
            <text class="team-col-net">å‡€èƒœåˆ†</text>
          </view>
          <view class="team-rank-row" wx:for="{{teamRankings || []}}" wx:key="teamIndex">
            <view class="team-col-rank">
              <text class="medal medal-1" wx:if="{{item.rank === 1}}">ğŸ¥‡</text>
              <text class="medal medal-2" wx:elif="{{item.rank === 2}}">ğŸ¥ˆ</text>
              <text class="medal medal-3" wx:elif="{{item.rank === 3}}">ğŸ¥‰</text>
              <text wx:else>{{item.rank}}</text>
            </view>
            <text class="team-col-name">{{item.teamLabel}}</text>
            <text class="team-col-wl">{{item.wins}}-{{item.losses}}</text>
            <text class="team-col-pts">{{item.points}}</text>
            <text class="team-col-net {{item.net >= 0 ? 'net-positive' : 'net-negative'}}">{{item.net >= 0 ? '+' : ''}}{{item.net}}</text>
          </view>
        </view>
      </view>
      <view class="card player-rank-by-team" wx:for="{{teamPlayerRankings || []}}" wx:key="teamIndex">
        <view class="section-title sub">{{item.teamLabel}} - é˜Ÿå‘˜æ’è¡Œæ¦œ</view>
        <view class="rankings-table" wx:if="{{item.players && item.players.length > 0}}">
          <view class="rank-header">
            <text class="col-rank">æ’å</text>
            <text class="col-player">é€‰æ‰‹</text>
            <text class="col-wl">èƒœ-è´Ÿ</text>
            <text class="col-pts">ç§¯åˆ†</text>
            <text class="col-net">å‡€èƒœåˆ†</text>
          </view>
          <view class="rank-row" wx:for="{{item.players}}" wx:for-item="p" wx:key="_id">
            <view class="col-rank">
              <text class="medal medal-1" wx:if="{{p.rankInTeam === 1}}">ğŸ¥‡</text>
              <text class="medal medal-2" wx:elif="{{p.rankInTeam === 2}}">ğŸ¥ˆ</text>
              <text class="medal medal-3" wx:elif="{{p.rankInTeam === 3}}">ğŸ¥‰</text>
              <text wx:else>{{p.rankInTeam}}</text>
            </view>
            <view class="col-player">
              <view class="avatar-wrap">
                <image class="avatar-sm" src="{{p.avatarUrl}}" mode="aspectFill" wx:if="{{p.avatarUrl}}"></image>
                <view class="avatar-sm avatar-placeholder" wx:else></view>
                <text class="me-tag" wx:if="{{p.isMe}}">æˆ‘</text>
              </view>
              <text>{{p.nickName || 'æœªçŸ¥'}}</text>
            </view>
            <text class="col-wl">{{p.wins}}-{{p.losses}}</text>
            <text class="col-pts">{{p.points}}</text>
            <text class="col-net {{p.net >= 0 ? 'net-positive' : 'net-negative'}}">{{p.net >= 0 ? '+' : ''}}{{p.net}}</text>
          </view>
        </view>
      </view>
    </block>
    <block wx:else>
      <view class="card">
        <view class="section-title">æ’å</view>
        <view class="rankings-table" wx:if="{{rankings.length > 0}}">
          <view class="rank-header">
            <text class="col-rank">æ’å</text>
            <text class="col-player">é€‰æ‰‹</text>
            <text class="col-wl">èƒœ-è´Ÿ</text>
            <text class="col-pts">ç§¯åˆ†</text>
            <text class="col-net">å‡€èƒœåˆ†</text>
          </view>
          <view class="rank-row" wx:for="{{rankings}}" wx:key="_id">
            <text class="col-rank">{{index + 1}}</text>
            <view class="col-player">
              <image class="avatar-sm" src="{{item.avatarUrl}}" mode="aspectFill" wx:if="{{item.avatarUrl}}"></image>
              <view class="avatar-sm avatar-placeholder" wx:else></view>
              <text>{{item.nickName || 'æœªçŸ¥'}}</text>
            </view>
            <text class="col-wl">{{item.wins}}-{{item.losses}}</text>
            <text class="col-pts">{{item.points}}</text>
            <text class="col-net {{item.net >= 0 ? 'net-positive' : 'net-negative'}}">{{item.net >= 0 ? '+' : ''}}{{item.net}}</text>
          </view>
        </view>
        <view class="empty-tip" wx:else>æš‚æ— æ’åæ•°æ®</view>
      </view>
    </block>
  </view>

  <!-- ç¬¬ä¸‰æ ï¼šå¯¹å±€ -->
  <view class="tab-content" wx:if="{{activeTab === 2 && match.teams && (match.status === 'teaming' || match.status === 'playing' || match.status === 'finished')}}">
    <view class="card">
      <view class="section-title">å¯¹å±€</view>
      <view class="matchups-list" wx:if="{{matchups.length > 0}}">
        <view class="matchup-item" wx:for="{{matchups}}" wx:key="gameIndex" bindtap="onMatchupTap" data-game-index="{{item.gameIndex}}">
          <view class="matchup-label">ç¬¬ {{item.gameIndex}} åœº</view>
          <view class="matchup-players" wx:if="{{!item.isDoubles}}">
            <view class="matchup-player">
              <image class="avatar-sm" src="{{item.player1.avatarUrl}}" mode="aspectFill" wx:if="{{item.player1.avatarUrl}}"></image>
              <view class="avatar-sm avatar-placeholder" wx:else></view>
              <text>{{item.player1.nickName || 'æœªçŸ¥'}}</text>
            </view>
            <view class="matchup-vs-wrap">
              <view class="matchup-vs">VS</view>
              <view class="matchup-score-display" wx:if="{{item.score1 != null && item.score2 != null}}">{{item.score1}} : {{item.score2}}</view>
            </view>
            <view class="matchup-player">
              <image class="avatar-sm" src="{{item.player2.avatarUrl}}" mode="aspectFill" wx:if="{{item.player2.avatarUrl}}"></image>
              <view class="avatar-sm avatar-placeholder" wx:else></view>
              <text>{{item.player2.nickName || 'æœªçŸ¥'}}</text>
            </view>
          </view>
          <view class="matchup-players matchup-doubles" wx:else>
            <view class="matchup-team">
              <text class="matchup-team-text">{{item.team1Names || 'æœªçŸ¥'}}</text>
            </view>
            <view class="matchup-vs-wrap">
              <view class="matchup-vs">VS</view>
              <view class="matchup-score-display" wx:if="{{item.score1 != null && item.score2 != null}}">{{item.score1}} : {{item.score2}}</view>
            </view>
            <view class="matchup-team">
              <text class="matchup-team-text">{{item.team2Names || 'æœªçŸ¥'}}</text>
            </view>
          </view>
          <view class="matchup-winner" wx:if="{{item.winner}}">
            <text wx:if="{{!item.isDoubles}}">èƒœï¼š{{item.winner === item.player1._id ? item.player1.nickName : item.player2.nickName}}</text>
            <text wx:else>èƒœï¼š{{item.winnerTeamText || 'ä¸€æ–¹'}}</text>
          </view>
        </view>
      </view>
      <view class="empty-tip" wx:else>æš‚æ— å¯¹å±€</view>
    </view>
  </view>

  <!-- æ—  teams æ—¶æ’å/å¯¹å±€ tab æç¤º -->
  <view class="tab-content" wx:if="{{activeTab === 1 && !(match.teams && (match.status === 'teaming' || match.status === 'playing' || match.status === 'finished'))}}">
    <view class="card">
      <view class="empty-tip">ç»„é˜Ÿåæ–¹å¯æŸ¥çœ‹æ’å</view>
    </view>
  </view>
  <view class="tab-content" wx:if="{{activeTab === 2 && !(match.teams && (match.status === 'teaming' || match.status === 'playing' || match.status === 'finished'))}}">
    <view class="card">
      <view class="empty-tip">ç»„é˜Ÿåæ–¹å¯æŸ¥çœ‹å¯¹å±€</view>
    </view>
  </view>
</view>
