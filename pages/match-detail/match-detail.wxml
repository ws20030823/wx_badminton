<!--pages/match-detail/match-detail.wxml - 比赛详情-->
<view class="container" wx:if="{{match}}">
  <view class="card match-info">
    <view class="match-name">{{match.name}}</view>
    <view class="match-meta">
      <text class="status-tag status-{{match.status}}">{{match.status === 'registering' ? '报名中' : match.status === 'teaming' ? '组队中' : match.status === 'playing' ? '进行中' : '已结束'}}</text>
      <text class="mode-tag">{{match.type === 'singles' ? '单打' : '双打'}} - {{match.subMode === 'single-turn' ? '单打转' : match.subMode === 'team-turn' ? '小队转' : '晋级赛'}}</text>
    </view>
    <view class="match-stats">
      <text>报名人数：{{match.players ? match.players.length : 0}} / {{match.maxPlayers}}</text>
    </view>
    <view class="match-extras" wx:if="{{match.location || match.time || match.startTime || match.endTime || match.courtNumber}}">
      <text wx:if="{{match.startTime && match.endTime}}">时间：{{match.startTime}} - {{match.endTime}}</text>
      <text wx:elif="{{match.startTime}}">开始：{{match.startTime}}</text>
      <text wx:elif="{{match.time}}">时间：{{match.time}}</text>
      <text wx:if="{{match.location}}">地点：{{match.location}}</text>
      <text wx:if="{{match.location && match.courtNumber}}"> ({{match.courtNumber}})</text>
    </view>
  </view>

  <!-- Tab 导航 -->
  <view class="tabs">
    <view class="tab-item {{activeTab === 0 ? 'active' : ''}}" data-index="0" bindtap="onTabChange">比赛</view>
    <view class="tab-item {{activeTab === 1 ? 'active' : ''}}" data-index="1" bindtap="onTabChange">排名</view>
    <view class="tab-item {{activeTab === 2 ? 'active' : ''}}" data-index="2" bindtap="onTabChange">对局</view>
  </view>

  <!-- 第一栏：比赛（报名） -->
  <view class="tab-content" wx:if="{{activeTab === 0}}">
    <view class="card">
      <view class="section-title">报名列表</view>
      <view class="player-list" wx:if="{{playerList.length > 0}}">
        <view class="player-item" wx:for="{{playerList}}" wx:key="_id">
          <image class="avatar" src="{{item.avatarUrl}}" mode="aspectFill" wx:if="{{item.avatarUrl}}"></image>
          <view class="avatar avatar-placeholder" wx:else></view>
          <text>{{item.nickName || '未知'}}</text>
        </view>
      </view>
      <view class="empty-tip" wx:else>暂无报名</view>
    </view>

    <view class="actions">
      <button
        wx:if="{{!hasJoined && match.status === 'registering'}}"
        class="btn-primary"
        bindtap="onJoinTap"
      >立即报名</button>

      <button
        wx:if="{{isCreator && match.status === 'registering'}}"
        class="btn-robot"
        bindtap="onAddRobotTap"
      >添加机器人（测试）</button>

      <button
        wx:if="{{isCreator && match.status === 'registering' && match.players && match.players.length >= match.minPlayers}}"
        class="btn-primary"
        bindtap="onStartTeamTap"
      >开始组队</button>
    </view>
  </view>

  <!-- 第二栏：排名 -->
  <view class="tab-content" wx:if="{{activeTab === 1 && match.teams && (match.status === 'teaming' || match.status === 'playing' || match.status === 'finished')}}">
    <view class="card">
      <view class="section-title">排名</view>
      <view class="rankings-table" wx:if="{{rankings.length > 0}}">
        <view class="rank-header">
          <text class="col-rank">排名</text>
          <text class="col-player">选手</text>
          <text class="col-wl">胜-负</text>
          <text class="col-pts">积分</text>
          <text class="col-net">净胜分</text>
        </view>
        <view class="rank-row" wx:for="{{rankings}}" wx:key="_id">
          <text class="col-rank">{{index + 1}}</text>
          <view class="col-player">
            <image class="avatar-sm" src="{{item.avatarUrl}}" mode="aspectFill" wx:if="{{item.avatarUrl}}"></image>
            <view class="avatar-sm avatar-placeholder" wx:else></view>
            <text>{{item.nickName || '未知'}}</text>
          </view>
          <text class="col-wl">{{item.wins}}-{{item.losses}}</text>
          <text class="col-pts">{{item.points}}</text>
          <text class="col-net {{item.net >= 0 ? 'net-positive' : 'net-negative'}}">{{item.net >= 0 ? '+' : ''}}{{item.net}}</text>
        </view>
      </view>
      <view class="empty-tip" wx:else>暂无排名数据</view>
    </view>
  </view>

  <!-- 第三栏：对局 -->
  <view class="tab-content" wx:if="{{activeTab === 2 && match.teams && (match.status === 'teaming' || match.status === 'playing' || match.status === 'finished')}}">
    <view class="card">
      <view class="section-title">对局</view>
      <view class="matchups-list" wx:if="{{matchups.length > 0}}">
        <view class="matchup-item" wx:for="{{matchups}}" wx:key="gameIndex" bindtap="onMatchupTap" data-game-index="{{item.gameIndex}}">
          <view class="matchup-label">第 {{item.gameIndex}} 场</view>
          <view class="matchup-players" wx:if="{{!item.isDoubles}}">
            <view class="matchup-player">
              <image class="avatar-sm" src="{{item.player1.avatarUrl}}" mode="aspectFill" wx:if="{{item.player1.avatarUrl}}"></image>
              <view class="avatar-sm avatar-placeholder" wx:else></view>
              <text>{{item.player1.nickName || '未知'}}</text>
            </view>
            <view class="matchup-vs-wrap">
              <view class="matchup-vs">VS</view>
              <view class="matchup-score-display" wx:if="{{item.score1 != null && item.score2 != null}}">{{item.score1}} : {{item.score2}}</view>
            </view>
            <view class="matchup-player">
              <image class="avatar-sm" src="{{item.player2.avatarUrl}}" mode="aspectFill" wx:if="{{item.player2.avatarUrl}}"></image>
              <view class="avatar-sm avatar-placeholder" wx:else></view>
              <text>{{item.player2.nickName || '未知'}}</text>
            </view>
          </view>
          <view class="matchup-players matchup-doubles" wx:else>
            <view class="matchup-team">
              <text class="matchup-team-text">{{item.team1Names || '未知'}}</text>
            </view>
            <view class="matchup-vs-wrap">
              <view class="matchup-vs">VS</view>
              <view class="matchup-score-display" wx:if="{{item.score1 != null && item.score2 != null}}">{{item.score1}} : {{item.score2}}</view>
            </view>
            <view class="matchup-team">
              <text class="matchup-team-text">{{item.team2Names || '未知'}}</text>
            </view>
          </view>
          <view class="matchup-winner" wx:if="{{item.winner}}">
            <text wx:if="{{!item.isDoubles}}">胜：{{item.winner === item.player1._id ? item.player1.nickName : item.player2.nickName}}</text>
            <text wx:else>胜：{{item.winnerTeamText || '一方'}}</text>
          </view>
        </view>
      </view>
      <view class="empty-tip" wx:else>暂无对局</view>
    </view>
  </view>

  <!-- 无 teams 时排名/对局 tab 提示 -->
  <view class="tab-content" wx:if="{{activeTab === 1 && !(match.teams && (match.status === 'teaming' || match.status === 'playing' || match.status === 'finished'))}}">
    <view class="card">
      <view class="empty-tip">组队后方可查看排名</view>
    </view>
  </view>
  <view class="tab-content" wx:if="{{activeTab === 2 && !(match.teams && (match.status === 'teaming' || match.status === 'playing' || match.status === 'finished'))}}">
    <view class="card">
      <view class="empty-tip">组队后方可查看对局</view>
    </view>
  </view>
</view>
